
@using API.Models

@{
    Layout = "~/Views/Shared/DashboardLayout.cshtml";
}

@{
    bool IsApiActive = false;
    int Requests = 0;
    float RequestsPercent = 0;
    string ApiKey = "";
    int ClientId = ((ViewBag.Client as IEnumerable<Client>).First().Id);
    DateTime? DateCreated = null;
    string ProgressClass = "bg-success";
    int Limit = 1;

    if (ViewBag.ApiKey.Count > 0)
    {
        IsApiActive = ((ViewBag.ApiKey as IEnumerable<ApiKey>).First().IsActive);
        Requests = ((ViewBag.ApiKey as IEnumerable<ApiKey>).First().AmountOfRequests);
        Limit = ((ViewBag.ApiKey as IEnumerable<ApiKey>).First().Limit);
        RequestsPercent = ((float)Requests / Limit) * 100;
        ApiKey = ((ViewBag.ApiKey as IEnumerable<ApiKey>).First().Key);
        DateCreated = DateTime.Parse(((ViewBag.ApiKey as IEnumerable<ApiKey>).First().DateCreated.ToString()));
    }

    if (Requests > 5000)
    {
        ProgressClass = "bg-warning";
    }
    else if (Requests >= 8000)
    {
        ProgressClass = "bg-danger";
    }
}

<div class="alert alert-warning" role="alert">
    Do not share your API key with anyone. If your API key becomes compromised <a href="/Dashboard/Settings" class="link-primary"><strong>Disable</strong></a> your key.
</div>

<nav aria-label="breadcrumb">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="#">Dashboard</a></li>
        <li class="breadcrumb-item active" aria-current="page">Overview</li>
    </ol>
</nav>
<div class="d-inline-flex flex-grow-1 w-100 gap-5 flex-wrap">
    <div class="card text-bg-light mb-3 flex-grow-1">
        <div class="card-header d-inline-flex justify-content-between">
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-key-fill" viewBox="0 0 16 16">
                    <path d="M3.5 11.5a3.5 3.5 0 1 1 3.163-5H14L15.5 8 14 9.5l-1-1-1 1-1-1-1 1-1-1-1 1H6.663a3.5 3.5 0 0 1-3.163 2M2.5 9a1 1 0 1 0 0-2 1 1 0 0 0 0 2" />
                </svg>
                API Key
            </div>
            <span class="text-secondary ps-2">Generated on @DateCreated</span>
        </div>
        <div class="card-body">
            @if (string.IsNullOrEmpty(ApiKey))
            {
                <a href="/Dashboard/GenerateApiKey/?ClientId=@ClientId" class="btn btn-success">Generate API Key</a>
            }
            else
            {
                <p class="text-center" id="apiKey">@ApiKey</p>
            }
        </div>
    </div>
    <div class="card text-bg-light mb-3 flex-grow-1">
        <div class="card-header">
            <div class="d-inline-flex justify-content-between w-100">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pie-chart-fill" viewBox="0 0 16 16">
                        <path d="M15.985 8.5H8.207l-5.5 5.5a8 8 0 0 0 13.277-5.5zM2 13.292A8 8 0 0 1 7.5.015v7.778zM8.5.015V7.5h7.485A8 8 0 0 0 8.5.015" />
                    </svg>
                    API Usage Statistics
                </div>
                @if (IsApiActive)
                {<span class="badge text-bg-success">Active</span> }
                else
                { <span class="badge text-bg-danger">Disabled</span>}
            </div>
        </div>
        <div class="card-body">
            <p>@Requests /  @Limit.ToString("N0") Requests</p>
            <div class="progress" role="progressbar" aria-label="Basic example" aria-valuenow="75" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar @ProgressClass" style="width: @RequestsPercent%"></div>
            </div>
        </div>
    </div>
</div>
<div class="d-flex flex-column">
    <div class="card text-bg-light mb-3 flex-grow-1">
        <div class="card-header">
            <div class="d-inline-flex justify-content-between w-100">
                <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-table" viewBox="0 0 16 16">
                        <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm15 2h-4v3h4zm0 4h-4v3h4zm0 4h-4v3h3a1 1 0 0 0 1-1zm-5 3v-3H6v3zm-5 0v-3H1v2a1 1 0 0 0 1 1zm-4-4h4V8H1zm0-4h4V4H1zm5-3v3h4V4zm4 4H6v3h4z" />
                    </svg>
                    Last 100 API Calls
                </div>
            </div>
        </div>
        <div class="card-body">
            <table class="table table-hover table-sm">
                <thead>
                    <tr>
                        <th scope="col">#</th>
                        <th scope="col">Method</th>
                        <th scope="col">Route</th>
                        <th scope="col">Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    @{
                        uint index = 0;
                        foreach (ApiLog apiLog in ViewBag.ApiLogs)
                        {
                            index++;
                            <tr>
                                <th scope="row">@index</th>
                                <td>@apiLog.Method</td>
                                <td>@apiLog.Route</td>
                                <td>@apiLog.Timestamp</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    @Scripts.Render("~/bundles/jquery")
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation@1.19.5/dist/jquery.validate.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery-validation-unobtrusive@3.2.12/dist/jquery.validate.unobtrusive.js"></script>
    <script src="~/Scripts/utils.js"></script>
}

